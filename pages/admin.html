<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Vape Market</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-dashboard {
            padding: 24px;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .admin-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border);
        }
        
        .admin-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .admin-card h3 i {
            color: var(--primary);
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .user-list, .report-list, .ad-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item, .report-item, .ad-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .user-item:last-child, .report-item:last-child, .ad-item:last-child {
            border-bottom: none;
        }
        
        .user-info, .report-info, .ad-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .user-details, .report-details, .ad-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .admin-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-admin {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .verified-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 10px;
            margin-left: 8px;
        }
        
        .banned-badge {
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 10px;
            margin-left: 8px;
        }
        
        .search-admin {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-smoking"></i>
            <span>Vape Market</span>
        </div>
        <div class="nav-menu">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Кабинет</span>
            </a>
            <a href="faq.html" class="nav-link">
                <i class="fas fa-question-circle"></i>
                <span>FAQ</span>
            </a>
            <a href="admin.html" class="nav-link active">
                <i class="fas fa-shield-alt"></i>
                <span>Админ</span>
            </a>
        </div>
        <div class="nav-user" id="userAvatar">
            <div class="avatar-placeholder">А</div>
        </div>
    </nav>

    <div class="admin-dashboard">
        <h1><i class="fas fa-shield-alt"></i> Административная панель</h1>
        
        <!-- Статистика -->
        <div class="admin-grid">
            <div class="admin-card">
                <h3><i class="fas fa-users"></i> Пользователи</h3>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Всего</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="newUsers">0</div>
                        <div class="stat-label">Новых (24ч)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="bannedUsers">0</div>
                        <div class="stat-label">Заблокированы</div>
                    </div>
                </div>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-tags"></i> Объявления</h3>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value" id="totalAds">0</div>
                        <div class="stat-label">Всего</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="activeAds">0</div>
                        <div class="stat-label">Активные</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="reportedAds">0</div>
                        <div class="stat-label">Жалобы</div>
                    </div>
                </div>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-chart-line"></i> Активность</h3>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value" id="totalViews">0</div>
                        <div class="stat-label">Просмотры</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="totalLikes">0</div>
                        <div class="stat-label">Лайки</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="avgRating">0.0</div>
                        <div class="stat-label">Ср. рейтинг</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Поиск -->
        <input type="text" class="search-admin" id="adminSearch" 
               placeholder="Поиск по пользователям, объявлениям, жалобам...">

        <!-- Вкладки -->
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="users">
                <i class="fas fa-users"></i> Пользователи
            </button>
            <button class="tab-button" data-tab="ads">
                <i class="fas fa-tags"></i> Объявления
            </button>
            <button class="tab-button" data-tab="reports">
                <i class="fas fa-flag"></i> Жалобы
            </button>
            <button class="tab-button" data-tab="banner">
                <i class="fas fa-ad"></i> Рекламный баннер
            </button>
            <button class="tab-button" data-tab="settings">
                <i class="fas fa-cog"></i> Настройки
            </button>
        </div>

        <!-- Контент вкладок -->
        <!-- Пользователи -->
        <div class="tab-content active" id="usersTab">
            <div class="admin-card">
                <h3><i class="fas fa-user-cog"></i> Управление пользователями</h3>
                <div class="user-list" id="userList">
                    <!-- Список пользователей загружается через JS -->
                </div>
            </div>
        </div>

        <!-- Объявления -->
        <div class="tab-content" id="adsTab">
            <div class="admin-card">
                <h3><i class="fas fa-list-alt"></i> Все объявления</h3>
                <div class="ad-list" id="adList">
                    <!-- Список объявлений загружается через JS -->
                </div>
            </div>
        </div>

        <!-- Жалобы -->
        <div class="tab-content" id="reportsTab">
            <div class="admin-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Необработанные жалобы</h3>
                <div class="report-list" id="reportList">
                    <!-- Список жалоб загружается через JS -->
                </div>
            </div>
        </div>

        <!-- Рекламный баннер -->
        <div class="tab-content" id="bannerTab">
            <div class="admin-card">
                <h3><i class="fas fa-ad"></i> Управление рекламным баннером</h3>
                <div class="form-group">
                    <label>Текст баннера</label>
                    <textarea id="bannerText" rows="3" 
                              placeholder="Введите текст рекламного баннера..."></textarea>
                </div>
                <div class="form-group">
                    <label>Цвет баннера</label>
                    <select id="bannerColor">
                        <option value="gradient">Фиолетовый градиент</option>
                        <option value="success">Зелёный</option>
                        <option value="warning">Жёлтый</option>
                        <option value="danger">Красный</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Показывать баннер?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="bannerVisible" value="yes" checked> Да
                        </label>
                        <label>
                            <input type="radio" name="bannerVisible" value="no"> Нет
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-secondary" onclick="previewBanner()">
                        <i class="fas fa-eye"></i> Предпросмотр
                    </button>
                    <button class="btn-primary" onclick="saveBanner()">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>
        </div>

        <!-- Настройки -->
        <div class="tab-content" id="settingsTab">
            <div class="admin-card">
                <h3><i class="fas fa-sliders-h"></i> Настройки системы</h3>
                <div class="form-group">
                    <label>Время жизни объявлений (дни)</label>
                    <input type="number" id="adLifetime" value="14" min="1" max="30">
                </div>
                <div class="form-group">
                    <label>Минимальный рейтинг для проверенного продавца</label>
                    <input type="number" id="minVerifiedRating" value="4.5" min="1" max="5" step="0.1">
                </div>
                <div class="form-group">
                    <label>Минимальное количество сделок для проверки</label>
                    <input type="number" id="minVerifiedDeals" value="10" min="1">
                </div>
                <div class="form-group">
                    <label>Автоматическая модерация объявлений</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="autoModeration" value="on" checked> Включена
                        </label>
                        <label>
                            <input type="radio" name="autoModeration" value="off"> Выключена
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Сохранить настройки
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно действий с пользователем -->
    <div class="modal" id="userActionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalUserName">Пользователь</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Действие</label>
                    <select id="userAction">
                        <option value="">Выберите действие</option>
                        <option value="verify">Выдать галочку проверенного</option>
                        <option value="unverify">Снять галочку проверенного</option>
                        <option value="ban">Заблокировать пользователя</option>
                        <option value="unban">Разблокировать пользователя</option>
                        <option value="promote">Повысить до модератора</option>
                        <option value="demote">Понизить до пользователя</option>
                        <option value="reset_rating">Сбросить рейтинг</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Причина (опционально)</label>
                    <textarea id="actionReason" rows="3" placeholder="Укажите причину действия..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-secondary modal-close">Отмена</button>
                    <button class="btn-danger" onclick="executeUserAction()">Выполнить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        // Проверка прав администратора
        document.addEventListener('DOMContentLoaded', async function() {
            // Ждем загрузки пользователя
            await new Promise(resolve => {
                const checkUser = setInterval(() => {
                    if (window.currentUser) {
                        clearInterval(checkUser);
                        resolve();
                    }
                }, 100);
            });
            
            // Проверяем, является ли пользователь администратором
            if (!currentUser || !currentUser.isAdmin) {
                alert('Доступ запрещен! Требуются права администратора.');
                window.location.href = 'index.html';
                return;
            }
            
            // Инициализация админ-панели
            initAdminPanel();
        });
        
        let selectedUserId = null;
        
        function initAdminPanel() {
            console.log('Инициализация админ-панели для', currentUser.username);
            
            // Загрузка статистики
            loadAdminStats();
            
            // Загрузка списка пользователей
            loadUsers();
            
            // Настройка вкладок
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.dataset.tab + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Поиск
            document.getElementById('adminSearch').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                searchAdminData(query);
            });
            
            // Модальные окна
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    closeAllModals();
                });
            });
        }
        
        async function loadAdminStats() {
            try {
                // Здесь будет запрос к API
                // const response = await fetch(`${CONFIG.API_URL}/admin/stats`);
                // const stats = await response.json();
                
                // Мок-данные
                const mockStats = {
                    totalUsers: 1247,
                    newUsers: 23,
                    bannedUsers: 8,
                    totalAds: 356,
                    activeAds: 289,
                    reportedAds: 12,
                    totalViews: 12456,
                    totalLikes: 2456,
                    avgRating: 4.3
                };
                
                // Обновляем UI
                Object.keys(mockStats).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.textContent = mockStats[key];
                    }
                });
                
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }
        
        async function loadUsers() {
            try {
                // Здесь будет запрос к API
                // const response = await fetch(`${CONFIG.API_URL}/admin/users`);
                // const users = await response.json();
                
                // Мок-данные
                const mockUsers = [
                    {
                        id: 'user1',
                        name: 'Алексей',
                        username: '@alexey',
                        rating: 4.7,
                        adsCount: 12,
                        isVerified: true,
                        isBanned: false,
                        isAdmin: false,
                        joinDate: '2024-01-15'
                    },
                    {
                        id: 'user2',
                        name: 'Мария',
                        username: '@maria',
                        rating: 4.9,
                        adsCount: 8,
                        isVerified: true,
                        isBanned: false,
                        isAdmin: false,
                        joinDate: '2024-02-10'
                    },
                    {
                        id: 'user3',
                        name: 'Дмитрий',
                        username: '@dmitry',
                        rating: 3.2,
                        adsCount: 3,
                        isVerified: false,
                        isBanned: true,
                        isAdmin: false,
                        joinDate: '2024-03-05'
                    },
                    {
                        id: 'user4',
                        name: 'Екатерина',
                        username: '@ekaterina',
                        rating: 4.5,
                        adsCount: 6,
                        isVerified: false,
                        isBanned: false,
                        isAdmin: true,
                        joinDate: '2024-01-20'
                    }
                ];
                
                renderUsers(mockUsers);
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                document.getElementById('userList').innerHTML = 
                    '<div class="error">Ошибка загрузки пользователей</div>';
            }
        }
        
        function renderUsers(users) {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-name">
                            ${user.name}
                            ${user.isVerified ? '<span class="verified-badge">Проверен</span>' : ''}
                            ${user.isBanned ? '<span class="banned-badge">Забанен</span>' : ''}
                            ${user.isAdmin ? '<span style="color: var(--primary);"><i class="fas fa-shield-alt"></i> Админ</span>' : ''}
                        </div>
                        <div class="user-details">
                            ${user.username} • Рейтинг: ${user.rating} • Объявлений: ${user.adsCount}
                        </div>
                    </div>
                    <div class="admin-actions">
                        <button class="btn-admin btn-secondary" onclick="viewUserDetails('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-admin btn-primary" onclick="showUserActions('${user.id}', '${user.name}')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function showUserActions(userId, userName) {
            selectedUserId = userId;
            document.getElementById('modalUserName').textContent = userName;
            document.getElementById('userActionModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        async function executeUserAction() {
            const action = document.getElementById('userAction').value;
            const reason = document.getElementById('actionReason').value;
            
            if (!action) {
                alert('Выберите действие');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/admin/user-action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: selectedUserId,
                        action: action,
                        reason: reason,
                        adminId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    alert('Действие успешно выполнено');
                    closeAllModals();
                    loadUsers(); // Обновляем список
                } else {
                    alert('Ошибка выполнения действия');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения');
            }
        }
        
        function searchAdminData(query) {
            // Поиск по всем элементам
            const searchableElements = document.querySelectorAll('.user-item, .ad-item, .report-item');
            
            searchableElements.forEach(element => {
                const text = element.textContent.toLowerCase();
                element.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }
        
        function previewBanner() {
            const text = document.getElementById('bannerText').value;
            const color = document.getElementById('bannerColor').value;
            
            alert(`Предпросмотр баннера:\n\n${text}\n\nЦвет: ${color}`);
        }
        
        async function saveBanner() {
            const text = document.getElementById('bannerText').value;
            const color = document.getElementById('bannerColor').value;
            const visible = document.querySelector('input[name="bannerVisible"]:checked').value;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/admin/banner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        color: color,
                        visible: visible === 'yes',
                        adminId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    alert('Баннер сохранен');
                } else {
                    alert('Ошибка сохранения баннера');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения');
            }
        }
        
        async function saveSettings() {
            const lifetime = document.getElementById('adLifetime').value;
            const minRating = document.getElementById('minVerifiedRating').value;
            const minDeals = document.getElementById('minVerifiedDeals').value;
            const autoMod = document.querySelector('input[name="autoModeration"]:checked').value;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/admin/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adLifetime: parseInt(lifetime),
                        minVerifiedRating: parseFloat(minRating),
                        minVerifiedDeals: parseInt(minDeals),
                        autoModeration: autoMod === 'on',
                        adminId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    alert('Настройки сохранены');
                } else {
                    alert('Ошибка сохранения настроек');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения');
            }
        }
    </script>
</body>
</html>
